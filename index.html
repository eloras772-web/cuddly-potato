<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üç© Krispy Kreme Stack (Con Leaderboard)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Importaciones de Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        
        // Exportar a scope global para que el script principal pueda usarlos
        window.firebase = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, orderBy, limit, getDocs, setLogLevel
        };
    </script>
    <style>
        /* --- ESTILOS GENERALES Y LAYOUT M√ìVIL --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8e6f1; /* Color suave de dona */
            display: flex;
            flex-direction: column; 
            align-items: center;
            padding: 10px;
            margin: 0;
            min-height: 100vh; 
            box-sizing: border-box;
        }

        /* --- CONTENEDOR PRINCIPAL: Ahora envuelve Info y Tablero --- */
        #contenedor-principal {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        /* --- ESTILOS DEL TABLERO DE JUEGO (Tama√±o Reducido) --- */
        .contenedor-juego {
            display: flex;
            flex-direction: column;
            align-items: center;
            order: 1; 
            position: relative; /* Contenedor general */
        }
        
        /* NUEVO CONTENEDOR DE REFERENCIA PARA LA PAUSA */
        #tablero-wrapper {
            position: relative; /* Base para posicionamiento absoluto de la pausa */
            margin-bottom: 20px; /* Mantiene el espacio debajo del tablero */
        }

        #tablero {
            border: 8px solid #D72828; 
            background-color: #FFFFFF; 
            display: grid;
            grid-template-columns: repeat(10, min(5vw, 20px));
            grid-template-rows: repeat(20, min(10vw, 20px));
            width: min(50vw, 200px); 
            height: min(100vw, 400px); 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 0; /* Movido al wrapper */
        }

        .celda {
            width: 100%; 
            height: 100%; 
            box-sizing: border-box;
            border: 1px solid #eee; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: min(4vw, 15px); 
        }
        
        /* --- ESTILOS DE LA INFORMACI√ìN --- */
        .info-panel {
            background-color: #D72828; 
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            width: min(90vw, 300px);
            margin-bottom: 20px;
            order: 0; 
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .info-panel p {
            font-size: 1em;
            margin: 0 5px;
            font-weight: 500;
        }
        
        /* --- ESTILOS DE LOS CONTROLES M√ìVILES --- */
        #controles-movil {
            order: 2; 
            width: min(90vw, 350px);
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
        }

        .control-btn {
            padding: 15px 5px;
            font-size: 1.1em;
            font-weight: bold;
            background-color: #FFFFFF;
            color: #D72828;
            border: 3px solid #D72828;
            border-radius: 8px;
            user-select: none; 
            cursor: pointer;
            text-align: center;
            transition: all 0.1s ease;
            box-shadow: 0 3px 0 #9E1F1F;
        }
        
        .control-btn.caida {
            grid-column: span 2; 
            background-color: #D72828;
            color: white;
            box-shadow: 0 3px 0 #9E1F1F;
        }
        
        #btn-pausa {
            background-color: #ff9800; 
            color: white;
            grid-column: span 2;
            box-shadow: 0 3px 0 #C47A00;
        }

        /* --- ESTILOS DEL MEN√ö DE INICIO/MODAL --- */
        #menu-inicio {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            padding: 20px;
        }

        /* --- LEADERBOARD STYLE --- */
        #leaderboard-container {
            background-color: white;
            color: #333;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            width: min(80vw, 300px);
            max-height: 250px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #leaderboard-container h2 {
            font-size: 1.4em;
            font-weight: bold;
            color: #D72828;
            margin-bottom: 10px;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 5px;
        }

        #leaderboard-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #leaderboard-list li {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.95em;
        }

        .rank-name { font-weight: bold; color: #2c3e50; }
        .score-value { color: #D72828; font-weight: 600; }

        /* MODAL PARA INGRESAR PUNTAJE */
        #input-score-modal {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001; 
            text-align: center;
            padding: 30px;
            font-size: 1.1em;
        }
        
        /* MENSAJE DE PAUSA: AHORA CUBRE SOLO EL TABLERO */
        #mensaje-pausa {
            position: absolute; /* Posicionamiento relativo al #tablero-wrapper */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            color: white;
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            font-weight: bold;
            z-index: 50; /* Alto para cubrir el tablero */
            letter-spacing: 5px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    
    <!-- AUDIO -->
    <audio id="musica-fondo" loop>
        <source src="musica.mp3" type="audio/mp3">
    </audio>

    <!-- PANTALLA DE INICIO (MEN√ö) -->
    <div id="menu-inicio">
        <!-- Donas flotantes de fondo -->
        <div class="dona-flotante d1">üç©</div>
        <div class="dona-flotante d2">üç©</div>
        <div class="dona-flotante d3">üç©</div>
        
        <h1>üç© KRISPY KREME STACK üç©</h1>
        <p>¬°Apila las donas y haz una torre perfecta!</p>
        
        <!-- Contenedor del Leaderboard -->
        <div id="leaderboard-container">
            <h2>üèÜ Tabla de Clasificaci√≥n üèÜ</h2>
            <ul id="leaderboard-list">
                <li>Cargando Leaderboard...</li>
            </ul>
        </div>
        
        <p style="font-size: 0.9em; opacity: 0.8; margin-top: 15px;">Tu ID de Jugador (para premios): <span id="user-id-display">Cargando...</span></p>

        <button onclick="iniciarJuego()">¬°Jugar Ahora!</button>
    </div>

    <!-- CONTENEDOR PRINCIPAL DEL JUEGO (Lo que ver√° el jugador) -->
    <div id="contenedor-principal">
        <!-- PANEL DE INFORMACI√ìN DURANTE EL JUEGO -->
        <div class="info-panel">
            <p>Nivel: <span id="nivel">0</span></p> 
            <p>Puntos: <span id="puntos">0</span></p>
            <p>L√≠neas: <span id="lineas">0</span></p>
        </div>

        <!-- CONTENEDOR DEL JUEGO -->
        <div class="contenedor-juego">
            <!-- NUEVO WRAPPER QUE CONTIENE TABLERO Y PAUSA -->
            <div id="tablero-wrapper">
                <div id="tablero">
                    <!-- Celdas del tablero generadas por JS -->
                </div>
                <!-- MENSAJE DE PAUSA POSICIONADO ABSOLUTAMENTE AQU√ç -->
                <div id="mensaje-pausa">PAUSA</div>
            </div>
        </div>
    </div>
    
    <!-- MODAL PARA INGRESAR PUNTAJE (Sigue cubriendo todo el viewport) -->
    <div id="input-score-modal">
        <p>¬°Nuevo Puntaje Alto!</p>
        <p>Tu puntaje: <span id="final-score">0</span></p>
        <p style="font-weight: normal;">Ingresa tu nombre para el Leaderboard:</p>
        <input type="text" id="player-name-input" placeholder="Ej: John Doe" maxlength="15">
        <button onclick="enviarPuntaje()">Guardar Puntaje</button>
    </div>
    
    <!-- CONTROLES M√ìVILES -->
    <div id="controles-movil">
        <button class="control-btn" onclick="mover(-1, 0)">‚¨ÖÔ∏è Izq</button>
        <button class="control-btn" onclick="rotar()">üîÑ Rotar</button>
        <button class="control-btn" onclick="mover(1, 0)">Der ‚û°Ô∏è</button>
        <button class="control-btn" onclick="mover(0, 1)">‚¨áÔ∏è Suave</button>
        <button class="control-btn caida" onclick="caidaRapida()">üí• Ca√≠da R√°pida</button>
        <button id="btn-pausa" class="control-btn" onclick="togglePausa()">‚è∏Ô∏è Pausa</button>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN Y DATOS DEL JUEGO ---
        const FILAS = 20;
        const COLUMNAS = 10;
        const DONA_EMOJI = 'üç©';
        const tableroDiv = document.getElementById('tablero');
        
        // --- VELOCIDADES Y NIVELES DE DIFICULTAD DIN√ÅMICA ---
        const VELOCIDADES_NIVEL = [
            1000, 850, 700, 550, 400, 250, 200, 150, 100
        ];
        
        let TIEMPO_CAIDA = VELOCIDADES_NIVEL[0];
        let nivelActual = 0;
        let juegoMatriz = []; 
        let intervaloCaida;
        let puntos = 0;
        let lineas = 0;
        let isPlaying = false; 
        let isPaused = false; 
        const btnPausa = document.getElementById('btn-pausa');
        const mensajePausa = document.getElementById('mensaje-pausa');
        
        // --- CONFIGURACI√ìN FIREBASE ---
        let app, db, auth;
        let userId = 'anon_user';
        let isAuthReady = false;
        
        const LEADERBOARD_PATH = `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/leaderboard`;

        const musicaFondo = document.getElementById('musica-fondo');
        musicaFondo.volume = 0.2; 
        let contextoAudio = null;
        
        const Formas = [
            [[0, 1, 0], [0, 1, 0], [1, 1, 0]], 
            [[0, 1, 0], [0, 1, 0], [0, 1, 1]], 
            [[0, 0, 0, 0], [1, 1, 1, 1], [0, 0, 0, 0], [0, 0, 0, 0]], 
            [[1, 1], [1, 1]], 
            [[0, 1, 1], [1, 1, 0], [0, 0, 0]], 
            [[1, 1, 0], [0, 1, 1], [0, 0, 0]], 
            [[0, 1, 0], [1, 1, 1], [0, 0, 0]]
        ];

        let bloqueActual = null;
        let proximoBloque = null;

        // --- FUNCIONES FIREBASE Y LEADERBOARD ---
        
        async function setupFirebase() {
            if (typeof window.firebase === 'undefined') {
                console.error("Firebase SDK no cargado. Leaderboard deshabilitado.");
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = 'Offline';
                return;
            }
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase Config missing. Running in offline mode.");
                    isAuthReady = true;
                    document.getElementById('user-id-display').textContent = 'Offline';
                    return;
                }

                app = firebase.initializeApp(firebaseConfig);
                db = firebase.getFirestore(app);
                auth = firebase.getAuth(app);
                firebase.setLogLevel('Debug');
                
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await firebase.signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = userId;
                loadLeaderboard();
                
            } catch (error) {
                console.error("Error setting up Firebase:", error);
                isAuthReady = true; 
            }
        }

        async function enviarPuntaje() {
            const playerNameInput = document.getElementById('player-name-input');
            let name = playerNameInput.value.trim();
            
            if (name.length < 2) {
                name = "An√≥nimo"; 
            }

            document.getElementById('input-score-modal').style.display = 'none';

            if (!isAuthReady || !db) {
                console.error("No se puede guardar el puntaje: Firebase no est√° listo.");
                iniciarJuego(); 
                return;
            }

            try {
                await firebase.addDoc(firebase.collection(db, LEADERBOARD_PATH), {
                    score: puntos,
                    name: name,
                    userId: userId,
                    date: firebase.serverTimestamp ? firebase.serverTimestamp() : Date.now(),
                    lines: lineas
                });
                console.log("Puntaje guardado exitosamente:", puntos);
            } catch (error) {
                console.error("Error al guardar el puntaje:", error);
            }

            playerNameInput.value = ''; 
            iniciarJuego();
        }
        
        function loadLeaderboard() {
            if (!isAuthReady || !db) return;

            const q = firebase.query(
                firebase.collection(db, LEADERBOARD_PATH),
                firebase.orderBy('score', 'desc'),
                firebase.limit(10)
            );

            firebase.onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                const list = document.getElementById('leaderboard-list');
                list.innerHTML = ''; 

                if (scores.length === 0) {
                    list.innerHTML = '<li>No hay puntajes a√∫n. ¬°S√© el primero!</li>';
                    return;
                }

                scores.forEach((scoreData, index) => {
                    const li = document.createElement('li');
                    const rank = index + 1;
                    
                    li.innerHTML = `
                        <span class="rank-name">${rank}. ${scoreData.name || 'An√≥nimo'}</span> 
                        <span class="score-value">${scoreData.score.toLocaleString()}</span>
                    `;
                    list.appendChild(li);
                });
            }, (error) => {
                console.error("Error fetching leaderboard: ", error);
                const list = document.getElementById('leaderboard-list');
                list.innerHTML = '<li>Error al cargar la tabla de clasificaci√≥n.</li>';
            });
        }

        // --- FUNCIONES DE M√öSICA Y SONIDO ---
        function iniciarMusicaDeFondo() { musicaFondo.play().catch(error => console.warn("Fallo al reproducir m√∫sica.")); }
        function detenerMusicaDeFondo() { musicaFondo.pause(); }

        function generarTono(frecuencia, duracion, volumen) {
            try {
                if (!contextoAudio) { contextoAudio = new (window.AudioContext || window.webkitAudioContext)(); }
                if (isPaused || contextoAudio.state !== 'running') return; 
                const oscilador = contextoAudio.createOscillator();
                const ganancia = contextoAudio.createGain();
                oscilador.connect(ganancia);
                ganancia.connect(contextoAudio.destination);
                oscilador.type = 'square'; 
                oscilador.frequency.setValueAtTime(frecuencia, contextoAudio.currentTime);
                ganancia.gain.setValueAtTime(volumen, contextoAudio.currentTime);
                ganancia.gain.exponentialRampToValueAtTime(0.00001, contextoAudio.currentTime + duracion);
                oscilador.start();
                oscilador.stop(contextoAudio.currentTime + duracion);
            } catch (error) { console.warn("El API de Audio para FX no est√° disponible."); }
        }
        function reproducirSonidoCaida() { generarTono(150, 0.2, 0.6); }
        function reproducirSonidoLinea() { generarTono(440, 0.4, 0.8); }
        
        // --- 2. FUNCIONES DE INTERFAZ, PUNTUACI√ìN Y DIFICULTAD ---

        function actualizarHUD() {
            document.getElementById('puntos').textContent = puntos;
            document.getElementById('lineas').textContent = lineas;
            document.getElementById('nivel').textContent = nivelActual; 
        }

        function ajustarVelocidad() {
            const nuevoNivel = Math.floor(lineas / 10);
            
            if (nuevoNivel > nivelActual && nuevoNivel < VELOCIDADES_NIVEL.length) {
                nivelActual = nuevoNivel;
                TIEMPO_CAIDA = VELOCIDADES_NIVEL[nivelNivel];
                
                if (isPlaying && !isPaused) {
                    clearInterval(intervaloCaida);
                    intervaloCaida = setInterval(juegoLoop, TIEMPO_CAIDA);
                }
                actualizarHUD();
            } else if (nuevoNivel >= VELOCIDADES_NIVEL.length) {
                 nivelActual = VELOCIDADES_NIVEL.length - 1;
            }
        }

        function generarTableroHTML() {
            tableroDiv.innerHTML = ''; 
            juegoMatriz = Array(FILAS).fill(0).map(() => Array(COLUMNAS).fill(0));
            for (let r = 0; r < FILAS; r++) {
                for (let c = 0; c < COLUMNAS; c++) {
                    const celda = document.createElement('div');
                    celda.classList.add('celda');
                    tableroDiv.appendChild(celda);
                }
            }
    
